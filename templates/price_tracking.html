<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Tracking - Amazon Crawler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .nav-link {
            color: rgba(255,255,255,0.8) !important;
            transition: all 0.3s;
        }
        .nav-link:hover, .nav-link.active {
            color: white !important;
            background-color: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        .price-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background: white;
            padding: 20px;
            margin-bottom: 20px;
        }
        .price-stat {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        .price-current {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }
        .price-min {
            background: linear-gradient(45deg, #28a745, #1e7e34);
            color: white;
        }
        .price-max {
            background: linear-gradient(45deg, #dc3545, #bd2130);
            color: white;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            position: relative;
            height: 500px;
        }
        .content-header {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .asin-selector {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 50px;
        }
        .error {
            display: none;
            text-align: center;
            padding: 50px;
            color: #dc3545;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white"><i class="fab fa-amazon text-warning"></i> Crawler</h4>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/batch-import">
                                <i class="fas fa-upload"></i> Batch Import
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/price-tracking">
                                <i class="fas fa-chart-line"></i> Theo dõi giá
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/products">
                                <i class="fas fa-box"></i> Sản phẩm
                            </a>
                        </li>

                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="content-header p-3 mt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2><i class="fas fa-chart-line text-primary"></i> Theo dõi biến động giá</h2>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshChart()">
                            <i class="fas fa-sync-alt"></i> Làm mới
                        </button>
                    </div>
                </div>

                <!-- ASIN Selector -->
                <div class="asin-selector">
                    <div class="row">
                        <div class="col-md-8">
                            <label for="asinSelect" class="form-label">Chọn sản phẩm để theo dõi:</label>
                            <div class="dropdown position-relative">
                                <input type="text" 
                                       class="form-control" 
                                       id="asinSearchInput" 
                                       placeholder="Tìm kiếm theo ASIN hoặc tên sản phẩm..." 
                                       autocomplete="off"
                                       onclick="toggleDropdown()"
                                       onkeyup="filterProducts()"
                                       onblur="hideDropdownDelay()">
                                <div class="dropdown-menu w-100" id="productDropdown" style="max-height: 300px; overflow-y: auto;">
                                    <div class="dropdown-item text-center text-muted">
                                        <i class="fas fa-spinner fa-spin"></i> Đang tải sản phẩm...
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="selectedASIN" value="">
                        </div>
                        <div class="col-md-4">
                            <label for="daysSelect" class="form-label">Thời gian:</label>
                            <select class="form-select" id="daysSelect" onchange="loadPriceHistory()">
                                <option value="7">7 ngày qua</option>
                                <option value="30" selected>30 ngày qua</option>
                                <option value="60">60 ngày qua</option>
                                <option value="90">90 ngày qua</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Price Statistics -->
                <div class="row" id="priceStats" style="display: none;">
                    <div class="col-md-12">
                        <div class="price-card">
                            <h5 class="mb-3"><i class="fas fa-info-circle"></i> <span id="productTitle">Thông tin giá</span></h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="price-stat price-current">
                                        <h6>Giá hiện tại</h6>
                                        <h3 id="currentPrice">0 đ</h3>
                                        <small>Cập nhật mới nhất</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="price-stat price-min">
                                        <h6>Thấp nhất</h6>
                                        <h3 id="minPrice">0 đ</h3>
                                        <small id="minDate">--</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="price-stat price-max">
                                        <h6>Cao nhất</h6>
                                        <h3 id="maxPrice">0 đ</h3>
                                        <small id="maxDate">--</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="row">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="loading" id="loading">
                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                <p>Đang tải dữ liệu...</p>
                            </div>
                            <div class="error" id="error">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                                <p>Không có dữ liệu biến động giá cho sản phẩm này</p>
                            </div>
                            <canvas id="priceChart" style="display: none;"></canvas>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let priceChart = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
        });

        let allProducts = [];
        let hideTimeout = null;

        // Load products list
        async function loadProducts() {
            try {
                const response = await fetch('/api/products/list');
                const data = await response.json();
                
                allProducts = data.products;
                displayProducts(allProducts);
                
                console.log(`Loaded ${data.products.length} products`);
                
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productDropdown').innerHTML = 
                    '<div class="dropdown-item text-center text-danger">Lỗi tải dữ liệu sản phẩm</div>';
            }
        }

        // Display products in dropdown
        function displayProducts(products) {
            const dropdown = document.getElementById('productDropdown');
            
            if (products.length === 0) {
                dropdown.innerHTML = '<div class="dropdown-item text-center text-muted">Không tìm thấy sản phẩm</div>';
                return;
            }
            
            dropdown.innerHTML = products.map(product => 
                `<div class="dropdown-item" style="cursor: pointer;" onclick="selectProduct('${product.asin}', '${product.title.replace(/'/g, "\\'")}')">
                    <div class="fw-bold">${product.asin}</div>
                    <small class="text-muted">${product.title}</small>
                </div>`
            ).join('');
        }

        // Toggle dropdown visibility
        function toggleDropdown() {
            const dropdown = document.getElementById('productDropdown');
            dropdown.classList.toggle('show');
            
            if (dropdown.classList.contains('show') && allProducts.length === 0) {
                loadProducts();
            }
        }

        // Filter products based on search input
        function filterProducts() {
            const searchTerm = document.getElementById('asinSearchInput').value.toLowerCase();
            const dropdown = document.getElementById('productDropdown');
            
            if (!searchTerm) {
                displayProducts(allProducts);
                dropdown.classList.add('show');
                return;
            }
            
            const filteredProducts = allProducts.filter(product => 
                product.asin.toLowerCase().includes(searchTerm) || 
                product.title.toLowerCase().includes(searchTerm)
            );
            
            displayProducts(filteredProducts);
            dropdown.classList.add('show');
        }

        // Select a product
        function selectProduct(asin, title) {
            document.getElementById('asinSearchInput').value = `${asin} - ${title}`;
            document.getElementById('selectedASIN').value = asin;
            document.getElementById('productDropdown').classList.remove('show');
            
            // Load price history for selected product
            loadPriceHistory();
        }

        // Hide dropdown with delay (for blur event)
        function hideDropdownDelay() {
            hideTimeout = setTimeout(() => {
                document.getElementById('productDropdown').classList.remove('show');
            }, 200);
        }

        // Cancel hide timeout (when clicking inside dropdown)
        document.getElementById('productDropdown').addEventListener('mousedown', function(e) {
            if (hideTimeout) {
                clearTimeout(hideTimeout);
            }
        });

        // Load price history
        async function loadPriceHistory() {
            const asin = document.getElementById('selectedASIN').value;
            const days = document.getElementById('daysSelect').value;
            
            if (!asin) {
                hideAll();
                return;
            }

            showLoading();
            
            try {
                const response = await fetch(`/api/price-history/${asin}?days=${days}`);
                
                if (!response.ok) {
                    throw new Error('No data found');
                }
                
                const data = await response.json();
                displayPriceChart(data);
                displayPriceStats(data);
                
            } catch (error) {
                console.error('Error loading price history:', error);
                showError();
            }
        }

        // Display price chart
        function displayPriceChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Destroy existing chart
            if (priceChart) {
                priceChart.destroy();
            }
            
            // Prepare data
            const labels = data.chart_data.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('vi-VN');
            });
            
            const prices = data.chart_data.map(item => item.price);
            
            // Find min/max points for highlighting
            const minIndex = prices.indexOf(data.min_price);
            const maxIndex = prices.indexOf(data.max_price);
            
            // Create point colors (highlight min/max)
            const pointColors = prices.map((price, index) => {
                if (index === minIndex) return '#28a745'; // Green for min
                if (index === maxIndex) return '#dc3545'; // Red for max
                return '#007bff'; // Blue for others
            });
            
            const pointSizes = prices.map((price, index) => {
                if (index === minIndex || index === maxIndex) return 8;
                return 4;
            });

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Giá bán ($)',
                        data: prices,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: pointColors,
                        pointBorderColor: pointColors,
                        pointRadius: pointSizes,
                        pointHoverRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Thời gian'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Giá ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US');
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    if (index === minIndex) return 'Giá thấp nhất';
                                    if (index === maxIndex) return 'Giá cao nhất';
                                    return '';
                                },
                                label: function(context) {
                                    return 'Giá: $' + context.parsed.y.toLocaleString('en-US');
                                }
                            }
                        }
                    }
                }
            });
            
            showChart();
        }

        // Display price statistics
        function displayPriceStats(data) {
            // Hiển thị mã ASIN thay vì title
            let asin = data.asin || document.getElementById('selectedASIN').value;
            document.getElementById('productTitle').textContent = asin || 'Thông tin giá';
            document.getElementById('currentPrice').textContent = '$' + data.current_price.toLocaleString('en-US');
            document.getElementById('minPrice').textContent = '$' + data.min_price.toLocaleString('en-US');
            document.getElementById('maxPrice').textContent = '$' + data.max_price.toLocaleString('en-US');
            document.getElementById('minDate').textContent = data.min_date;
            document.getElementById('maxDate').textContent = data.max_date;
            
            document.getElementById('priceStats').style.display = 'block';
        }

        // UI Helper functions
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('priceChart').style.display = 'none';
            document.getElementById('priceStats').style.display = 'none';
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('priceChart').style.display = 'none';
            document.getElementById('priceStats').style.display = 'none';
        }

        function showChart() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('priceChart').style.display = 'block';
        }

        function hideAll() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('priceChart').style.display = 'none';
            document.getElementById('priceStats').style.display = 'none';
        }

        function refreshChart() {
            loadPriceHistory();
        }
    </script>
</body>
</html> 